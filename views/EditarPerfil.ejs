<%- include("partials/head",{title:"Editar Perfil - Mercado Business"}) %>
</head>

<body>
    <%- include("partials/navbar") %>
    <main class="container-fluid p-0">
        <!-- Cabeçalho do Perfil -->
        <div class="profile-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        <img 
                            src="<%= myUser.profileImage %>" 
                            class="rounded-circle profile-img"
                            id="profileImagePreview"
                        >
                    </div>
                    <div class="col-md-6">
                        <h2 class="mb-1">Editar Perfil</h2>
                        <p class="mb-0">Atualize suas informações pessoais e profissionais</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="mt-3 mt-md-0">
                            <a href="/profile/user/<%= myUser.id %>" class="btn btn-outline-light fw-bold me-2">
                                <i class="bi bi-arrow-left"></i> Voltar
                            </a>
                            <button id="btn-save" class="btn btn-light fw-bold">
                                <i class="bi bi-check-lg"></i> Salvar Alterações
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-4">
            <form id="editProfileForm" action="/profile/edit/" method="POST" enctype="multipart/form-data">
                <!-- Alertas -->
                <%- include("partials/messages") %>
                <div class="row">
                    <!-- Coluna Esquerda - Informações Básicas -->
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white">
                                <h5 class="card-title mb-0">Informações Pessoais</h5>
                            </div>
                            <div class="card-body">
                                <!-- Imagem de Perfil -->
                                <div class="mb-4 text-center">
                                    <label for="profileImageInput" class="d-block">
                                        <img 
                                            src="<%= myUser.profileImage %>" 
                                            class="rounded-circle profile-img-edit"
                                            id="profileImageDisplay"
                                        >
                                    </label>
                                    <input 
                                        type="file" 
                                        id="profileImageInput" 
                                        name="profileImage" 
                                        accept="image/*" 
                                        class="d-none"
                                    >
                                    <div class="mt-2">
                                        <small class="text-muted">Clique na imagem para alterar</small>
                                    </div>
                                    <% if (errors.profileImage) { %>
                                        <div class="invalid-feedback d-block">
                                            <%= errors.profileImage.msg %>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- Nome -->
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nome Completo</label>
                                    <input 
                                        type="text" 
                                        class="form-control <%= errors.name ? 'is-invalid' : '' %>" 
                                        id="name" 
                                        name="name" 
                                        value="<%= old?.name || myUser.name %>"
                                        required
                                    >
                                    <% if (errors.name) { %>
                                        <div class="invalid-feedback">
                                            <%= errors.name.msg %>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- Nome de Usuário -->
                                <div class="mb-3">
                                    <label for="username" class="form-label">Nome de Usuário</label>
                                    <input 
                                        type="text" 
                                        class="form-control <%= errors.username ? 'is-invalid' : '' %>" 
                                        id="username" 
                                        name="username" 
                                        value="<%= old?.username || myUser.username %>"
                                        required
                                    >
                                    <% if (errors.username) { %>
                                        <div class="invalid-feedback">
                                            <%= errors.username.msg %>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- E-mail -->
                                <div class="mb-3">
                                    <label for="email" class="form-label">E-mail</label>
                                    <input 
                                        type="email" 
                                        class="form-control <%= errors.email ? 'is-invalid' : '' %>" 
                                        id="email" 
                                        name="email" 
                                        value="<%= old?.email || myUser.email %>"
                                        required
                                    >
                                    <% if (errors.email) { %>
                                        <div class="invalid-feedback">
                                            <%= errors.email.msg %>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- Telefone -->
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Telefone</label>
                                    <input 
                                        type="tel" 
                                        class="form-control <%= errors.phone ? 'is-invalid' : '' %>" 
                                        id="phone" 
                                        name="phone" 
                                        value="<%= old?.phone || myUser.phone %>"
                                    >
                                    <% if (errors.phone) { %>
                                        <div class="invalid-feedback">
                                            <%= errors.phone.msg %>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- Data de Nascimento -->
                                <div class="mb-3">
                                    <label for="dateOfBirth" class="form-label">Data de Nascimento</label>
                                    <input 
                                        type="date" 
                                        class="form-control <%= errors.dateOfBirth ? 'is-invalid' : '' %>" 
                                        id="dateOfBirth" 
                                        name="dateOfBirth" 
                                        value="<%= old?.dateOfBirth || myUser.dateOfBirth %>"
                                    >
                                    <% if (errors.dateOfBirth) { %>
                                        <div class="invalid-feedback">
                                            <%= errors.dateOfBirth.msg %>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- Endereço -->
                                <div class="mb-3">
                                    <label for="address" class="form-label">Endereço</label>
                                    <input 
                                        type="text" 
                                        class="form-control <%= errors.address ? 'is-invalid' : '' %>" 
                                        id="address" 
                                        name="address" 
                                        value="<%= old?.address || myUser.address %>"
                                    >
                                    <% if (errors.address) { %>
                                        <div class="invalid-feedback">
                                            <%= errors.address.msg %>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coluna Direita - Informações Profissionais -->
                    <div class="col-lg-6">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white">
                                <h5 class="card-title mb-0">Informações Profissionais</h5>
                            </div>
                            <div class="card-body">
                                <!-- Área de Atuação -->
                                <div class="mb-3">
                                    <label for="work" class="form-label">Área de Atuação</label>
                                    <select class="form-select <%= errors.work ? 'is-invalid' : '' %>" id="work" name="work" required>
                                        <option value="">Selecione uma área</option>
                                        <option value="contabilidade" <%= (old?.work || myUser.work) === 'contabilidade' ? 'selected' : '' %>>Contabilidade</option>
                                        <option value="marketing_digital" <%= (old?.work || myUser.work) === 'marketing_digital' ? 'selected' : '' %>>Marketing Digital</option>
                                        <option value="coaching" <%= (old?.work || myUser.work) === 'coaching' ? 'selected' : '' %>>Coaching</option>
                                        <option value="reformas" <%= (old?.work || myUser.work) === 'reformas' ? 'selected' : '' %>>Reformas</option>
                                    </select>
                                    <% if (errors.work) { %>
                                        <div class="invalid-feedback">
                                            <%= errors.work.msg %>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- Habilidades -->
                                <div class="mb-4">
                                    <label class="form-label">Habilidades</label>
                        
                                    <div id="skillsContainer" class="mb-3 <%= errors.skills ? 'is-invalid' : '' %>">
                                        <%  if (userSkills.length === 0){ %>
                                            <p class="text-muted" id="emptySkills">Nenhuma habilidade cadastrada.</p>
                                        <% } %>

                                        <% userSkills.forEach( userSkill => { %>
                                            <div class="skill-tag">
                                                <%= userSkill.skill %>
                                                <span class="skill-tag-remove" onclick="removeSkill(this)">×</span>
                                            </div>
                                        <% }) %>
                    
                                    </div>
                                    <% if (errors.skills) { %>
                                        <div class="invalid-feedback d-block">
                                            <%= errors.skills.msg %>
                                        </div>
                                    <% } %>
                                    <div class="input-group">
                                        <input 
                                            type="text" 
                                            class="form-control" 
                                            id="newSkillInput" 
                                            placeholder="Nova habilidade"
                                        >
                                        <button class="btn btn-outline-primary" type="button" onclick="addSkill()">
                                            Adicionar
                                        </button>
                                    </div>
                                    <input type="hidden" id="skills" name="skills">
                                </div>

                                <!-- Alteração de Senha -->
                                <div class="card shadow-sm mb-4">
                                    <div class="card-header bg-white">
                                        <h5 class="card-title mb-0">Alterar Senha</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="currentPassword" class="form-label">Senha Atual</label>
                                            <input 
                                                type="password" 
                                                class="form-control <%= errors.currentPassword ? 'is-invalid' : '' %>" 
                                                id="currentPassword" 
                                                name="currentPassword",
                                                minlength="8"
                                            >
                                            <% if (errors.currentPassword) { %>
                                                <div class="invalid-feedback">
                                                    <%= errors.currentPassword.msg %>
                                                </div>
                                            <% } %>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label">Nova Senha</label>
                                            <input 
                                                type="password" 
                                                class="form-control <%= errors.newPassword ? 'is-invalid' : '' %>" 
                                                id="newPassword" 
                                                name="newPassword",
                                                minlength="8"
                                            >
                                            <% if (errors.newPassword) { %>
                                                <div class="invalid-feedback">
                                                    <%= errors.newPassword.msg %>
                                                </div>
                                            <% } %>
                                            <small class="form-text text-muted">A senha deve ter no mínimo 8 caracteres, conter ao menos uma letra minúscula, uma maiúscula, um número e um caractere especial.</small>
                                        </div>
                                        <div class="mb-0">
                                            <label for="confirmPassword" class="form-label">Confirmar Nova Senha</label>
                                            <input 
                                                type="password" 
                                                class="form-control <%= errors.confirmPassword ? 'is-invalid' : '' %>" 
                                                id="confirmPassword" 
                                                name="confirmPassword"
                                                minlength="8"
                                            >
                                            <% if (errors.confirmPassword) { %>
                                                <div class="invalid-feedback">
                                                    <%= errors.confirmPassword.msg %>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <script>
        const btnSaveElement = document.getElementById('btn-save')
        const formEditProfile = document.getElementById('editProfileForm')
        // Pré-visualização da imagem de perfil
        document.getElementById('profileImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profileImageDisplay').src = e.target.result;
                    document.getElementById('profileImagePreview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // Gerenciamento de habilidades
        function addSkill() {
            const messageEmptySkills = document.getElementById('emptySkills')
            const skillInput = document.getElementById('newSkillInput');
            const skillText = skillInput.value.trim();
            const currentSkills = document.querySelectorAll('#skillsContainer .skill-tag').length;

            if (skillText && currentSkills < 5) {
                const skillContainer = document.getElementById('skillsContainer');
                const skillTag = document.createElement('div');
                skillTag.className = 'skill-tag';
                skillTag.innerHTML = `${skillText} <span class="skill-tag-remove" onclick="removeSkill(this)">×</span>`;
                skillContainer.appendChild(skillTag);
                skillInput.value = '';
                updateSkillsHiddenInput();
                if(messageEmptySkills) messageEmptySkills.remove()
                if (currentSkills  >= 4) skillInput.disabled = true
            } 
        }

        function removeSkill(element) {
            const skillInput = document.getElementById('newSkillInput');
            element.parentElement.remove();
            updateSkillsHiddenInput();
            const currentSkills = document.querySelectorAll('#skillsContainer .skill-tag').length;
            if(currentSkills < 5){
                skillInput.disabled = false
            }
        }

        function updateSkillsHiddenInput() {
            const skills = [];
            document.querySelectorAll('#skillsContainer .skill-tag').forEach(tag => {
                skills.push(tag.textContent.replace('×', '').trim());
            });
            document.getElementById('skills').value = JSON.stringify(skills);
        }


        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            updateSkillsHiddenInput();

            // Máscara para o telefone
            const phoneInput = document.getElementById('phone');
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                
                if (value.length <= 10) {
                    value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
                } else {
                    value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
                }
                
                e.target.value = value;
            });

            // Aplicar máscara ao valor inicial se necessário
            let initialValue = phoneInput.value.replace(/\D/g, '');
            if (initialValue.length <= 10) {
                initialValue = initialValue.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            } else {
                initialValue = initialValue.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
            }
            phoneInput.value = initialValue;
        });
        btnSaveElement.addEventListener('click',(e)=> {
            formEditProfile.submit()
        })
    </script>
<%- include("partials/foot") %>