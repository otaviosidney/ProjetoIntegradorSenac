<%- include("partials/head",{title:`${post ? 'Editar Postagem' : 'Nova Postagem'} | Mercado Business` } ) %>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<body>
    
    <%- include("partials/navbar") %>
    <!-- Conteúdo Principal -->
    <main class="container mt-5 pt-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">
                        <% if (post) { %>
                            Editar Postagem
                        <% } else { %>
                            Nova Postagem
                        <% } %>
                    </h1>
                    <a href="/profile/user/<%= myUser.id %>" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar ao Perfil
                    </a>
                </div>

                <!-- Alertas -->
                <% if (errors.content) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <%= errors.content.msg %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                <% } %>

                <!-- Container para o alerta de validação client-side -->
                <div id="alertContainer"></div>

                <!-- Formulário de Postagem -->
                <form 
                    action="<%= post ? '/posts/edit/' + post.id : '/posts/create' %>" 
                    method="POST" 
                    id="postForm"
                >
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">Conteúdo da Postagem</h5>
                        </div>
                        <div class="card-body">
                            <!-- Conteúdo -->
                            <div class="mb-3">
                                <div class="editor-container">
                                    <div id="editor">
                                        <% if (post && post.content) { %>
                                            <%- post.content %>
                                        <% } %>
                                    </div>
                                </div>
                                <input type="hidden" id="content" name="content">
                            </div>
                        </div>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="d-flex justify-content-between action-buttons">
                        <div>
                            <% if (post) { %>
                                <!-- Modal de Confirmação para Excluir -->
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                    <i class="bi bi-trash"></i> Excluir Postagem
                                </button>
                            <% } %>
                        </div>
                        <div>
                            <a href="/profile/user/<%= myUser.id %>" class="btn btn-secondary me-2">
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg"></i> 
                                <% if (post) { %>
                                    Atualizar Postagem
                                <% } else { %>
                                    Publicar Postagem
                                <% } %>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Modal de Confirmação para Excluir -->
    <% if (post) { %>
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteModalLabel">Confirmar Exclusão</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Tem certeza que deseja excluir esta postagem? Esta ação não pode ser desfeita.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form action="/posts/delete/<%= post.id %>" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-danger">Excluir Permanentemente</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    <% } %>

    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <script>
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['blockquote', 'code-block'],
                    ['clean']
                ]
            },
            placeholder: 'Compartilhe suas ideias, conhecimentos ou experiências...'
        });

        // Template do alerta que será usado para criar novos alertas
        const alertTemplate = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-circle-fill me-2"></i>
                <span class="alert-message">Por favor, adicione conteúdo à postagem antes de enviar.</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;

        function isContentEmpty() {
            const textContent = quill.getText().trim();
            const htmlContent = quill.root.innerHTML.trim();
            
            return textContent === '' || 
                   htmlContent === '<p><br></p>' || 
                   htmlContent === '<p></p>' ||
                   htmlContent === '<br>' ||
                   htmlContent === '';
        }

        function showAlert(message) {
            const alertContainer = document.getElementById('alertContainer');
            
            // Limpa qualquer alerta existente
            alertContainer.innerHTML = '';
            
            // Cria novo alerta a partir do template
            alertContainer.innerHTML = alertTemplate;
            
            // Atualiza a mensagem
            const alertMessage = alertContainer.querySelector('.alert-message');
            alertMessage.textContent = message;
            
            // Adiciona evento para quando o alerta for fechado
            const closeButton = alertContainer.querySelector('.btn-close');
            closeButton.addEventListener('click', function() {
                // Quando fechar, apenas limpa o container
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 300); // Espera a animação de fade terminar
            });
            
            // Scroll para o alerta
            alertContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Focar no editor
            quill.focus();
        }

        function hideAlert() {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '';
        }

        // Esconder alerta quando o usuário começar a digitar
        quill.on('text-change', function() {
            if (!isContentEmpty()) {
                hideAlert();
            }
        });

        document.getElementById('postForm').addEventListener('submit', function(e) {
            if (isContentEmpty()) {
                e.preventDefault();
                showAlert('Por favor, adicione conteúdo à postagem antes de enviar.');
                return;
            }

            document.getElementById('content').value = quill.root.innerHTML;
        });

        <% if (post && post.content) { %>
            quill.root.innerHTML = `<%- post.content %>`;
        <% } %>
    </script>
<%- include("partials/foot") %>